<html>
  <head>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <style>
  body {
    background-image: linear-gradient(to bottom, rgba(30, 144, 255, 0.6), rgba(0, 255, 255, 0.6));
    font-family: 'Noto Sans JP';
    font-size: 25px;
    line-height: 42px;
    letter-spacing: 0.018em;
    margin: 15px;
    height: 100vh;
  }

  select {
    font-size: 19px;
  }

  #bassNote {
    font-size: 19px;
    width: 50px;
  }

  button {
    font-size: 19px;
  }

  .hint {
    font-size: 15px;
    line-height: 22px;
  }

  #text {
    font-family: 'Garamond'
  }

  #after{
    font-size: 15px;
    line-height: 22px
  }

  .bold {
    font-size: 30px;
    font-weight: bold;
  }

  .numeral {
    font-family: 'Garamond';
    font-size: 33px;
    font-weight: bold;
  }
  </style>
  </head>
  <body>
    <div><h1>Unfigured Bass</h1></div><hr>
    <div>
      <select id="key">
        <option value="Cmaj">C Major</option>
        <option value="Gmaj">G Major</option>
        <option value="Dmaj">D Major</option>
        <option value="Amaj">A Major</option>
        <option value="Emaj">E Major</option>
        <option value="Bmaj">B Major</option>
        <option value="Gbmaj">Gb Major</option>
        <option value="Dbmaj">Db Major</option>
        <option value="Abmaj">Ab Major</option>
        <option value="Ebmaj">Eb Major</option>
        <option value="Bbmaj">Bb Major</option>
        <option value="Fmaj">F Major</option>
        <option disabled>–––––––––</option>
        <option value="Amin">A Minor</option>
        <option value="Emin">E Minor</option>
        <option value="Bmin">B Minor</option>
        <option value="F#min">F# Minor</option>
        <option value="C#min">C# Minor</option>
        <option value="G#min">G# Minor</option>
        <option value="Ebmin">Eb Minor</option>
        <option value="Bbmin">Bb Minor</option>
        <option value="Fmin">F Minor</option>
        <option value="Cmin">C Minor</option>
        <option value="Gmin">G Minor</option>
        <option value="Dmin">D Minor</option>
      </select>
      <select id="inversion">
        <option value="root">Root</option>
        <option value="6">6</option>
        <option value="6/4">6/4</option>
        <option disabled>––––</option>
        <option value="7">7</option>
        <option value="6/5">6/5</option>
        <option value="4/3">4/3</option>
        <option value="4/2">4/2</option>
      </select>
      <input type="text" id="bassNote" value="C">
      <button onclick="flat()">&#9837;</button>
      <button onclick="sharp()">#</button>
      <button onclick="natural()">♮</button>
      <button onclick="doubleFlat()">&#9837;&#9837;</button>
      <button onclick="doubleSharp()">x</button>
      <button onclick="search()">Search</button>
      <p class="hint" id="hint"></p>
    </div>
    <hr>
    <div id="text"></div><br><div id="after"></div>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
var keyObjects = [],
    key,
    bassNote,
    inversion,
    noteIndex,
    chordMembers;

function createKeyObject(key,i,ii,iii,iv,v,vi,vii) {
  this.name = key;
  this.iNotes = i + ", " + iii + ", " + v;
  this.iiNotes = ii + ", " + iv + ", " + vi;
  this.ii7Notes = ii + ", " + iv + ", " + vi + ", " + i; 
  this.iiiNotes = iii + ", " + v + ", " + vii;
  this.ivNotes = iv + ", " + vi + ", " + i;
  this.vNotes = v + ", " + vii + ", " + ii;
  this.v7Notes = v + ", " + vii + ", " + ii + ", " + iv;
  this.viNotes = vi + ", " + i + ", " + iii;
  function determine7() {
    let seven = vi;
    if (vi.includes('b')) {
      seven += 'b'
    }
    if (vi.includes('#')) {
      seven = seven.replace('#', '♮')
    }
    if (!vi.includes('b') && !vi.includes('#')) {
      seven += 'b'
    }
    return seven;
  }
  this.viiNotes = vii + ", " + ii + ", " + iv;
  this.vii7Notes = vii + ", " + ii + ", " + iv + ", " + determine7();
  this.I = this.iNotes.split(", ")
  this.ii = this.iiNotes.split(", ")
  this.ii7 = this.ii7Notes.split(", ")
  this.iii = this.iiiNotes.split(", ")
  this.IV = this.ivNotes.split(", ")
  this.V = this.vNotes.split(", ")
  this.V7 = this.v7Notes.split(", ")
  this.vi = this.viNotes.split(", ")
  this.viiº = this.viiNotes.split(", ")
  this.viiº7 = this.vii7Notes.split(", ")
}

function createMinorObject(key,i,ii,iii,iv,v,vi,vii) {
  this.name = key;
  function determine3() {
    let three = v;
    if (v.includes('b')) {
      three = three.replace('b', '♮')
    }
    if (v.includes('#')) {
      three = three.replace('#', 'x')
    }
    if (!v.includes('b') && !v.includes('#')) {
      three += '#'
    }
    return three;
  }
  this.iNotes = vi + ", " + i + ", " + iii;
  function determineDim() {
    var dim = vi;
    if (vi.includes('b')) {
      dim += 'b'
    }
    if (vi.includes('#')) {
      dim = dim.replace('#', '♮')
    }
    if (!vi.includes('b') && !vi.includes('#')) {
      dim += 'b'
    }
    return dim;
  }
  this.iiNotes = vii + ", " + ii + ", " + iv;
  this.iiHalfDim7Notes = vii + ", " + ii + ", " + iv + ", " + vi;
  this.iiDim7Notes = vii + ", " + ii + ", " + iv + ", " + determineDim();
  this.iiiNotes = i + ", " + iii + ", " + v;
  this.ivNotes = ii + ", " + iv + ", " + vi;
  this.vNotes = iii + ", " + determine3() + ", " + vii;
  this.v7Notes = iii + ", " + determine3() + ", " + vii + ", " + ii;
  this.viNotes = iv + ", " + vi + ", " + i;
  this.viiNotes = determine3() + ", " + vii + ", " + ii;
  this.vii7Notes = determine3() + ", " + vii + ", " + ii + ", " + iv;
  this.i = this.iNotes.split(", ")
  this.iiº = this.iiNotes.split(", ")
  this.iiø7 = this.iiHalfDim7Notes.split(", ");
  this.iiº7 = this.iiDim7Notes.split(", ")
  this.III = this.iiiNotes.split(", ")
  this.iv = this.ivNotes.split(", ")
  this.V = this.vNotes.split(", ")
  this.V7 = this.v7Notes.split(", ")
  this.VI = this.viNotes.split(", ")
  this.viiº = this.viiNotes.split(", ")
  this.viiº7 = this.vii7Notes.split(", ")
}

const Cmaj = new createKeyObject('Cmaj','C','D','E','F','G','A','B'),
      Gmaj = new createKeyObject('Gmaj','G','A','B','C','D','E','F#'),
      Dmaj = new createKeyObject('Dmaj','D','E','F#','G','A','B','C#'),
      Amaj = new createKeyObject('Amaj','A','B','C#','D','E','F#','G#'),
      Emaj = new createKeyObject('Emaj','E','F#','G#','A','B','C#','D#'),
      Bmaj = new createKeyObject('Bmaj','B','C#','D#','E','F#','G#','A#'),
      Gbmaj = new createKeyObject('Gbmaj','Gb','Ab','Bb','Cb','Db','Eb','F'),
      Dbmaj = new createKeyObject('Dbmaj','Db','Eb','F','Gb','Ab','Bb','C'),
      Abmaj = new createKeyObject('Abmaj','Ab','Bb','C','Db','Eb','F','G'),
      Ebmaj = new createKeyObject('Ebmaj','Eb','F','G','Ab','Bb','C','D'),
      Bbmaj = new createKeyObject('Bbmaj','Bb','C','D','Eb','F','G','A'),
      Fmaj = new createKeyObject('Fmaj','F','G','A','Bb','C','D','E'),
      
      Amin = new createMinorObject('Amin','C','D','E','F','G','A','B'),
      Emin = new createMinorObject('Emin','G','A','B','C','D','E','F#'),
      Bmin = new createMinorObject('Bmin','D','E','F#','G','A','B','C#'),
      FSmin = new createMinorObject('F#min','A','B','C#','D','E','F#','G#'),
      CSmin = new createMinorObject('C#min','E','F#','G#','A','B','C#','D#'),
      GSmin = new createMinorObject('G#min','B','C#','D#','E','F#','G#','A#'),
      Ebmin = new createMinorObject('Ebmin','Gb','Ab','Bb','Cb','Db','Eb','F'),
      Bbmin = new createMinorObject('Bbmin','Db','Eb','F','Gb','Ab','Bb','C'),
      Fmin = new createMinorObject('Fmin','Ab','Bb','C','Db','Eb','F','G'),
      Cmin = new createMinorObject('Cmin','Eb','F','G','Ab','Bb','C','D'),
      Gmin = new createMinorObject('Gmin','Bb','C','D','Eb','F','G','A'),
      Dmin = new createMinorObject('Dmin','F','G','A','Bb','C','D','E');

keyObjects.push(Cmaj,Gmaj,Dmaj,Amaj,Emaj,Bmaj,Gbmaj,Dbmaj,Abmaj,Ebmaj,Bbmaj,Fmaj,Amin,Emin,Bmin,FSmin,CSmin,GSmin,Ebmin,Bbmin,Fmin,Cmin,Gmin,Dmin)

function update() {
  key = $("#key").val();
  bassNote = $("#bassNote").val();
  inversion = $("#inversion").val();
  if (inversion == "root" || inversion == "7") {
    noteIndex = 0;
  }
  if (inversion == "6" || inversion == "6/5") {
    noteIndex = 1;
  }
  if (inversion == "6/4" || inversion == "4/3") {
    noteIndex = 2;
  }
  if (inversion == "4/2") {
    noteIndex = 3;
  }
  if (inversion == "root" || inversion == "6" || inversion == "6/4") {
    chordMembers = 3
  }
  if (inversion == "7" || inversion == "6/5" || inversion == "4/3" || inversion == "4/2") {
    chordMembers = 4
  }
}

function findKeySig(element) {
  if (element.name == key) {
    return true
  } else {
    return false
  }
}

function filterOutChords(object) {
  var chord = [];
  var result = [];
  for (var prop in object) {
    if (Array.isArray(object[prop]) && object[prop].length == chordMembers && object[prop].some(function(e){return e.includes(bassNote)})) {
      chord.push(object[prop])
    }
  }
  for (var i = 0; i < chord.length; i++) {
    if (chord[i].indexOf(bassNote) == noteIndex) {
      result.push(chord[i])
    }
  }
  if (result.length == 0) {result.push(["N/A"])}
  return result;
}

function filterResultChord(result, keyObject) {
  var final;
  for (var prop in keyObject) {
    if (Array.isArray(keyObject[prop]) && arraysEqual(result, keyObject[prop])) {
      final = prop
    }
  }
  return final;
}

function arraysEqual(arr1, arr2) {
    if(arr1.length !== arr2.length)
        return false;
    for(var i = arr1.length; i--;) {
        if(arr1[i] !== arr2[i])
            return false;
    }
    return true;
}

function search() {
  update();
  var filteredKey = keyObjects.filter(function(k){return k.name == key});
  var filteredNote = filterOutChords(filteredKey[0]);
  var resultChord = filterResultChord(filteredNote[0], filteredKey[0]);
  console.log(filteredNote[0]);
  console.log(resultChord)
  $("#text").html('')
  $("#after").html('')
  for (var i = 0; i < filteredNote[0].length; i++) {
    if (i == noteIndex) {
      $("#text").prepend("<span class ='bold'>" + filteredNote[0][i] + "</span><br>")
    } else {
      $("#text").prepend(filteredNote[0][i] + "<br>")
    }
  }
  $("#text").prepend("<span class='numeral'>" + resultChord + ":</span><br><br>")
  if (inversion == "root") {
    $("#text").append("<br>Double the root (" + filteredNote[0][0] + ")")
  }
  if (inversion == "6" && resultChord !== "viiº" && resultChord !== "iiº") {
    $("#text").append("<br>If possible, double the root (" + filteredNote[0][0] + ")")
  }
  if (inversion == "6" && (resultChord == "viiº" || resultChord == "iiº")) {
    $("#text").append("<br>Double the third (" + filteredNote[0][1] + ") for diminished triads in first inversion")
  }
  if (inversion == "6/4") {
    $("#text").append("<br>Double the fifth (" + filteredNote[0][2] + ")")
  }
  if ((inversion == "7" || inversion == "6/5" || inversion == "4/3" || inversion == "4/2") && filteredNote[0][0] !== "N/A") {
    if (arraysEqual(filteredNote[0], filteredKey[0].V7)) {
      $("#text").append("<br>If possible, resolve leading tone (" + filteredNote[0][1] + ") up and chordal seventh (" + filteredNote[0][3] + ") down")
    }
    if (arraysEqual(filteredNote[0], filteredKey[0].viiº7)) {
      $("#after").prepend("<br>If possible, resolve leading tone (" + filteredNote[0][0] + ") up and chordal seventh (" + filteredNote[0][3] + ") down")
    }
    $("#hint").html("Hint: Remember to notate the proper figured bass in Roman numeral analysis!")
  }
  if (resultChord == "iiø7") {
    $("#after").prepend("Note: Lower the seventh scale degree (" + filteredNote[0][3] + ") for iiº7<br><br>")
  }
}

function flat() {
  $("#bassNote").val($("#bassNote").val() + 'b')
}
function sharp() {
  $("#bassNote").val($("#bassNote").val() + '#')
}
function natural() {
  $("#bassNote").val($("#bassNote").val() + '♮')
}
function doubleFlat() {
  $("#bassNote").val($("#bassNote").val() + 'bb')
}
function doubleSharp() {
  $("#bassNote").val($("#bassNote").val() + 'x')
}

$('input[type=text]').on('keydown', function(e) {
  if (e.keyCode === 13) {
    this.blur();
  }
})

$('input[type=text]').on('focus', function() {
  $(this).val('')
})
</script>

  </body>
</html>
